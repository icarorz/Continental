<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Continental</title>
  <!-- Viewport para diseño responsive en móviles -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS (CDN) con integridad adaptada -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
    crossorigin="anonymous"
  >
  <style>
    /* Fondo con un degradado suave */
    body {
      background: linear-gradient(to right, #f6f0c4, #dae2f8);
      min-height: 100vh;
    }

    /* Ocultar elementos si es necesario */
    .hidden {
      display: none !important;
    }

    /* Tarjetas semitransparentes */
    .custom-card {
      background-color: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(2px);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .custom-card-header {
      background-color: rgba(255, 255, 255, 0.5);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    /*
      Resaltar líder y último.
      Usamos selectores más específicos para sobrescribir 
      el fondo que aplica .table-striped en <tr>.
    */
    .table-striped tbody tr.bg-winner > * {
      background-color: #d4edda !important; /* verde suave */
    }
    .table-striped tbody tr.bg-loser > * {
      background-color: #fff3cd !important; /* naranja suave */
    }
  </style>
</head>
<body>
  <div class="container py-4">

    <h1 class="text-center mb-4">Continental</h1>

    <!-- Sección Alta de Jugadores -->
    <div class="player-registration custom-card p-3 mb-4">
      <h2 class="mb-3">Alta de Jugadores</h2>
      
      <div class="input-group mb-3">
        <input 
          type="text" 
          id="playerNameInput" 
          class="form-control" 
          placeholder="Nombre del jugador" 
          aria-label="Nombre del jugador"
        />
        <button class="btn btn-primary" onclick="addPlayer()">Añadir Jugador</button>
      </div>

      <div class="player-list mb-3">
        <h4>Jugadores registrados:</h4>
        <ul id="playerList" class="list-group"></ul>
      </div>

      <button 
        id="startGameBtn" 
        onclick="startGame()" 
        class="btn btn-success hidden"
      >
        Iniciar Partida
      </button>
    </div>

    <!-- Sección Información de la Ronda -->
    <div class="round-info custom-card p-3 mb-4 hidden" id="roundInfoSection">
      <div class="custom-card-header p-2 mb-3 rounded">
        <h2 class="m-0">
          Ronda <span id="roundNumber"></span>:
          <small class="text-muted" id="roundDescription"></small>
        </h2>
      </div>

      <!-- Banner del repartidor más grande -->
      <p class="mb-3">
        <strong>Reparte:</strong>
        <span id="dealerName" class="badge text-bg-primary fs-4 px-3 py-2"></span>
      </p>

      <div>
        <h3>Introduce puntos de esta ronda</h3>
        <!-- row para inputs -->
        <div id="playersInputPoints" class="row">
          <!-- Aquí se generan dinámicamente los inputs de cada jugador -->
        </div>
        <button
          class="btn btn-primary mt-3"
          onclick="submitRoundPoints()"
        >
          Registrar Puntos y Pasar a la Siguiente Ronda
        </button>
      </div>
    </div>

    <!-- Sección Tabla de Puntuaciones -->
    <div class="score-table custom-card p-3 mb-4 hidden" id="scoreTableSection">
      <h2 class="mb-3">Puntuaciones Acumuladas</h2>
      <!-- table-responsive para scroll horizontal en móvil -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Jugador</th>
              <th>Ronda 1</th>
              <th>Ronda 2</th>
              <th>Ronda 3</th>
              <th>Ronda 4</th>
              <th>Ronda 5</th>
              <th>Ronda 6</th>
              <th>Ronda 7</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody" class="table-group-divider"></tbody>
        </table>
      </div>
    </div>

    <!-- Sección Ranking Final -->
    <div class="custom-card p-3 mb-4 hidden" id="finalRankingSection">
      <h2>Ranking Final</h2>
      <ol id="finalRankingList" class="list-group list-group-numbered mb-3"></ol>
      <button
        class="btn btn-warning"
        onclick="restartGame()"
      >
        Iniciar una nueva partida
      </button>
    </div>

  </div><!-- Fin .container -->

  <!-- Bootstrap JavaScript (CDN) con integridad adaptada -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"
  ></script>

  <script>
    /* ===============================
       Lógica de la aplicación
    =============================== */

    // Lista de jugadores (cada uno: { name, points[], total })
    let players = [];

    // Descripción de las 7 rondas
    const roundsDescription = [
      "Dos tríos",
      "Dos escaleras",
      "Dos tríos, Una escalera",
      "Dos escaleras, Un trío",
      "Tres tríos",
      "Tres escaleras",
      "Dos tríos, Dos escaleras"
    ];

    // Índice de la ronda actual
    let currentRound = 0;
    // Índice del jugador que reparte
    let dealerIndex = 0;
    // Índice del jugador elegido para iniciar la repartida (por checkbox en alta)
    let selectedDealerIndex = -1;

    // Índice del jugador que consigue -10 (opcional en su momento si siguiera existiendo)
    let bonusIndex = -1; // no lo estamos usando aquí, pero lo dejamos por si se quisiera retomar la lógica

    /* Agregar un jugador con su checkbox de "inicia repartiendo" */
    function addPlayer() {
      const input = document.getElementById("playerNameInput");
      const name = input.value.trim();
      if (name !== "") {
        players.push({
          name: name,
          points: new Array(7).fill(null),
          total: 0
        });
        input.value = "";
        renderPlayerList();
      }
    }

    /* Renderiza la lista de jugadores con su checkbox de "primer repartidor" */
    function renderPlayerList() {
      const playerListElement = document.getElementById("playerList");
      playerListElement.innerHTML = "";

      players.forEach((player, index) => {
        // Creamos un item <li> con un checkbox + nombre
        const li = document.createElement("li");
        li.classList.add("list-group-item", "d-flex", "align-items-center");

        // Checkbox para marcar quién inicia repartiendo
        const check = document.createElement("input");
        check.type = "checkbox";
        check.classList.add("form-check-input", "me-2");
        check.id = `startDealerCheck-${index}`;
        // Si ya se marcó antes, lo mantenemos
        if (selectedDealerIndex === index) {
          check.checked = true;
        }

        check.onchange = () => handleDealerCheck(index, check.checked);

        // Span con el nombre del jugador
        const span = document.createElement("span");
        span.textContent = `${index + 1}. ${player.name}`;

        li.appendChild(check);
        li.appendChild(span);
        playerListElement.appendChild(li);
      });

      // Mostrar botón de "Iniciar Partida" si hay 2+ jugadores
      document.getElementById("startGameBtn").classList.toggle("hidden", players.length < 2);
    }

    /* Si marcamos un checkbox de primer repartidor, desmarcamos los demás */
    function handleDealerCheck(idx, isChecked) {
      if (isChecked) {
        selectedDealerIndex = idx;
        // Desmarcar el resto
        players.forEach((_, i) => {
          if (i !== idx) {
            document.getElementById(`startDealerCheck-${i}`).checked = false;
          }
        });
      } else {
        // Si se desmarca, ningún jugador es el primero
        // (a no ser que marquemos otro)
        selectedDealerIndex = -1;
      }
    }

    /* Iniciar la partida */
    function startGame() {
      if (players.length < 2) {
        alert("Debes tener al menos 2 jugadores para iniciar la partida.");
        return;
      }
      // Ocultamos la sección de alta
      document.querySelector(".player-registration").classList.add("hidden");

      // Configuramos el dealerIndex según el checkbox (si lo hay)
      dealerIndex = selectedDealerIndex >= 0 ? selectedDealerIndex : 0;

      // Mostramos secciones
      document.getElementById("roundInfoSection").classList.remove("hidden");
      document.getElementById("scoreTableSection").classList.remove("hidden");

      currentRound = 0;
      initializeScoreTable();
      showRoundInfo();
    }

    /* Muestra la info de la ronda actual (quién reparte, inputs, etc.) */
    function showRoundInfo() {
      document.getElementById("roundNumber").textContent = currentRound + 1;
      document.getElementById("roundDescription").textContent = roundsDescription[currentRound];
      document.getElementById("dealerName").textContent = players[dealerIndex].name;

      const container = document.getElementById("playersInputPoints");
      container.innerHTML = "";

      players.forEach((player, index) => {
        const div = document.createElement("div");
        // Queremos que 4 jugadores entren en una fila en pantallas grandes
        div.classList.add("col-6", "col-md-3", "mb-3");

        const label = document.createElement("label");
        label.classList.add("form-label", "fw-semibold");
        label.textContent = `Puntos de ${player.name}:`;

        const input = document.createElement("input");
        input.type = "number";
        input.id = `pointsInput-${index}`;
        // Tamaño reducido, con .form-control
        input.classList.add("form-control", "mt-1");

        div.appendChild(label);
        div.appendChild(input);
        container.appendChild(div);
      });
    }

    /* Al pulsar 'Registrar Puntos', guardamos y pasamos a la siguiente ronda */
    function submitRoundPoints() {
      players.forEach((player, index) => {
        const input = document.getElementById(`pointsInput-${index}`);
        let roundPoints = parseInt(input.value) || 0;
        // (Si hubiera el bonus -10, se restaría aquí)
        player.points[currentRound] = roundPoints;
      });

      updateScoreTable();

      // Cambia el repartidor secuencialmente
      dealerIndex = (dealerIndex + 1) % players.length;

      if (currentRound === 6) {
        showFinalRanking();
      } else {
        currentRound++;
        showRoundInfo();
      }
    }

    /* Inicializa la tabla de puntuaciones vacía */
    function initializeScoreTable() {
      const tbody = document.getElementById("scoreTableBody");
      tbody.innerHTML = "";

      players.forEach((player, index) => {
        const row = document.createElement("tr");
        row.id = `row-${index}`;

        // # Jugador
        const indexCell = document.createElement("td");
        indexCell.textContent = index + 1;
        row.appendChild(indexCell);

        // Nombre
        const nameCell = document.createElement("td");
        nameCell.textContent = player.name;
        row.appendChild(nameCell);

        // 7 rondas
        for (let i = 0; i < 7; i++) {
          const roundCell = document.createElement("td");
          roundCell.id = `score-${index}-r${i + 1}`;
          roundCell.textContent = "-";
          row.appendChild(roundCell);
        }

        // Total
        const totalCell = document.createElement("td");
        totalCell.id = `total-${index}`;
        totalCell.textContent = "0";
        row.appendChild(totalCell);

        tbody.appendChild(row);
      });
    }

    /* Actualiza la tabla y destaca ganador/perdedor */
    function updateScoreTable() {
      players.forEach((player, index) => {
        let sum = 0;
        for (let i = 0; i < 7; i++) {
          const roundPoints = player.points[i] ?? 0;
          sum += roundPoints;
          const roundCell = document.getElementById(`score-${index}-r${i + 1}`);
          roundCell.textContent = roundPoints || roundPoints === 0 ? roundPoints : "-";
        }
        player.total = sum;
        document.getElementById(`total-${index}`).textContent = sum;
      });

      // Hallar quién tiene el total mínimo y el máximo
      let minPoints = Infinity;
      let maxPoints = -Infinity;
      players.forEach((p) => {
        if (p.total < minPoints) minPoints = p.total;
        if (p.total > maxPoints) maxPoints = p.total;
      });

      // Limpiamos y aplicamos estilos de resaltado
      players.forEach((player, index) => {
        const row = document.getElementById(`row-${index}`);
        row.classList.remove("bg-winner", "bg-loser");

        if (player.total === minPoints) {
          row.classList.add("bg-winner");
        }
        if (player.total === maxPoints) {
          row.classList.add("bg-loser");
        }
      });
    }

    /* Muestra el ranking final tras la última ronda */
    function showFinalRanking() {
      document.getElementById("roundInfoSection").classList.add("hidden");
      const finalRankingSection = document.getElementById("finalRankingSection");
      finalRankingSection.classList.remove("hidden");

      const sortedPlayers = [...players].sort((a, b) => a.total - b.total);
      const rankingList = document.getElementById("finalRankingList");
      rankingList.innerHTML = "";
      sortedPlayers.forEach((player) => {
        const li = document.createElement("li");
        li.textContent = `${player.name} - ${player.total} puntos`;
        li.classList.add("list-group-item");
        rankingList.appendChild(li);
      });
    }

    /* Reinicia la partida con los mismos jugadores */
    function restartGame() {
      players.forEach((player) => {
        player.points = new Array(7).fill(null);
        player.total = 0;
      });
      currentRound = 0;
      // Conservar la elección del repartidor inicial, si se desea
      dealerIndex = selectedDealerIndex >= 0 ? selectedDealerIndex : 0;

      document.getElementById("roundInfoSection").classList.remove("hidden");
      document.getElementById("finalRankingSection").classList.add("hidden");

      initializeScoreTable();
      showRoundInfo();
    }
  </script>
</body>
</html>

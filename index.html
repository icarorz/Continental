<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Continental</title>
  <!-- Viewport para diseño responsive en móviles -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS (CDN) con integridad adaptada -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
    crossorigin="anonymous"
  >
  <style>
    /* Fondo con un degradado suave */
    body {
      background: linear-gradient(to right, #f6f0c4, #dae2f8);
      min-height: 100vh;
    }

    /* Ocultar elementos si es necesario */
    .hidden {
      display: none !important;
    }

    /* Tarjetas semitransparentes */
    .custom-card {
      background-color: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(2px);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .custom-card-header {
      background-color: rgba(255, 255, 255, 0.5);
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    /* Resaltar ganador y perdedor */
    .bg-winner {
      background-color: #d4edda !important; /* verde suave */
    }
    .bg-loser {
      background-color: #fff3cd !important; /* naranja suave */
    }

  </style>
</head>
<body>
  <div class="container py-4">

    <h1 class="text-center mb-4">Continental</h1>

    <!-- Sección Alta de Jugadores -->
    <div class="player-registration custom-card p-3 mb-4">
      <h2 class="mb-3">Alta de Jugadores</h2>
      <div class="input-group mb-3">
        <input 
          type="text" 
          id="playerNameInput" 
          class="form-control" 
          placeholder="Nombre del jugador" 
          aria-label="Nombre del jugador"
        />
        <button class="btn btn-primary" onclick="addPlayer()">Añadir Jugador</button>
      </div>

      <div class="player-list mb-3">
        <h4>Jugadores registrados:</h4>
        <ul id="playerList" class="list-group"></ul>
      </div>

      <button 
        id="startGameBtn" 
        onclick="startGame()" 
        class="btn btn-success hidden"
      >
        Iniciar Partida
      </button>
    </div>

    <!-- Sección Información de la Ronda -->
    <div class="round-info custom-card p-3 mb-4 hidden" id="roundInfoSection">
      <div class="custom-card-header p-2 mb-3 rounded">
        <h2 class="m-0">
          Ronda <span id="roundNumber"></span>:
          <small class="text-muted" id="roundDescription"></small>
        </h2>
      </div>

      <!-- Banner del repartidor más grande -->
      <p class="mb-3">
        <strong>Reparte:</strong>
        <span id="dealerName" class="badge text-bg-primary fs-4 px-3 py-2"></span>
      </p>

      <div>
        <h3>Introduce puntos de esta ronda</h3>
        <!-- row para inputs -->
        <div id="playersInputPoints" class="row">
          <!-- Aquí se generan dinámicamente los inputs de cada jugador -->
        </div>
        <button
          class="btn btn-primary mt-3"
          onclick="submitRoundPoints()"
        >
          Registrar Puntos y Pasar a la Siguiente Ronda
        </button>
      </div>
    </div>

    <!-- Sección Tabla de Puntuaciones -->
    <div class="score-table custom-card p-3 mb-4 hidden" id="scoreTableSection">
      <h2 class="mb-3">Puntuaciones Acumuladas</h2>
      <!-- table-responsive para scroll horizontal en móvil -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered text-center align-middle">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Jugador</th>
              <th>Ronda 1</th>
              <th>Ronda 2</th>
              <th>Ronda 3</th>
              <th>Ronda 4</th>
              <th>Ronda 5</th>
              <th>Ronda 6</th>
              <th>Ronda 7</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody" class="table-group-divider"></tbody>
        </table>
      </div>
    </div>

    <!-- Sección Ranking Final -->
    <div class="custom-card p-3 mb-4 hidden" id="finalRankingSection">
      <h2>Ranking Final</h2>
      <ol id="finalRankingList" class="list-group list-group-numbered mb-3"></ol>
      <button
        class="btn btn-warning"
        onclick="restartGame()"
      >
        Iniciar una nueva partida
      </button>
    </div>

  </div><!-- Fin .container -->

  <!-- Bootstrap JS (CDN) con integridad adaptada -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"
  ></script>

  <script>
    /* ===============================
       Lógica de la aplicación
    =============================== */
    let players = [];
    const roundsDescription = [
      "Dos tríos",
      "Dos escaleras",
      "Dos tríos, Una escalera",
      "Dos escaleras, Un trío",
      "Tres tríos",
      "Tres escaleras",
      "Dos tríos, Dos escaleras"
    ];
    let currentRound = 0;
    let dealerIndex = 0;

    // Índice del jugador que obtiene la jugada de -10. -1 = nadie.
    let bonusIndex = -1;

    /* Agregar jugador */
    function addPlayer() {
      const input = document.getElementById("playerNameInput");
      const name = input.value.trim();
      if (name !== "") {
        players.push({
          name: name,
          points: new Array(7).fill(null),
          total: 0
        });
        input.value = "";
        renderPlayerList();
      }
    }

    function renderPlayerList() {
      const playerListElement = document.getElementById("playerList");
      playerListElement.innerHTML = "";
      players.forEach((player, index) => {
        const li = document.createElement("li");
        li.textContent = `${index + 1}. ${player.name}`;
        li.classList.add("list-group-item");
        playerListElement.appendChild(li);
      });
      document.getElementById("startGameBtn").classList.toggle("hidden", players.length < 2);
    }

    /* Iniciar partida */
    function startGame() {
      if (players.length < 2) {
        alert("Debes tener al menos 2 jugadores para iniciar la partida.");
        return;
      }
      document.querySelector(".player-registration").classList.add("hidden");
      document.getElementById("roundInfoSection").classList.remove("hidden");
      document.getElementById("scoreTableSection").classList.remove("hidden");

      currentRound = 0;
      dealerIndex = 0;
      initializeScoreTable();
      showRoundInfo();
    }

    /* Mostrar info de la ronda actual */
    function showRoundInfo() {
      document.getElementById("roundNumber").textContent = currentRound + 1;
      document.getElementById("roundDescription").textContent = roundsDescription[currentRound];
      document.getElementById("dealerName").textContent = players[dealerIndex].name;

      // Al cambiar de ronda, nadie tiene el bonus todavía
      bonusIndex = -1;

      const container = document.getElementById("playersInputPoints");
      container.innerHTML = "";

      players.forEach((player, index) => {
        const div = document.createElement("div");
        // Ajustar las columnas para que quepan 4 jugadores en la misma fila (en pantallas grandes)
        // col-6 => 2 campos por fila en móviles horizontales
        // col-md-3 => 4 campos por fila en tablet/pc
        div.classList.add("col-6", "col-md-3", "mb-3");

        // Etiqueta con el nombre
        const label = document.createElement("label");
        label.classList.add("form-label", "fw-semibold");
        label.textContent = `Puntos de ${player.name}:`;

        // Input de número
        const input = document.createElement("input");
        input.type = "number";
        input.id = `pointsInput-${index}`;
        input.classList.add("form-control", "mt-1");

        // Checkbox -10
        const checkboxDiv = document.createElement("div");
        checkboxDiv.classList.add("form-check", "mt-2");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.classList.add("form-check-input");
        checkbox.id = `bonusCheck-${index}`;
        checkbox.onchange = () => handleBonusCheck(index, checkbox.checked);

        const checkboxLabel = document.createElement("label");
        checkboxLabel.textContent = "¿-10?";
        checkboxLabel.classList.add("form-check-label", "ms-1");
        checkboxLabel.setAttribute("for", `bonusCheck-${index}`);

        checkboxDiv.appendChild(checkbox);
        checkboxDiv.appendChild(checkboxLabel);

        div.appendChild(label);
        div.appendChild(input);
        div.appendChild(checkboxDiv);
        container.appendChild(div);
      });
    }

    /* Lógica para el checkbox de -10 */
    function handleBonusCheck(playerIndex, isChecked) {
      if (isChecked) {
        // Si marcamos a este jugador con -10, desmarcamos y deshabilitamos el resto
        bonusIndex = playerIndex;
        players.forEach((_, i) => {
          const cb = document.getElementById(`bonusCheck-${i}`);
          if (i !== playerIndex) {
            cb.checked = false;
            cb.disabled = true;
          }
        });
      } else {
        // Si lo desmarcamos, entonces volvemos a habilitar todos
        bonusIndex = -1;
        players.forEach((_, i) => {
          const cb = document.getElementById(`bonusCheck-${i}`);
          cb.disabled = false;
        });
      }
    }

    /* Registrar puntos y pasar a la siguiente ronda */
    function submitRoundPoints() {
      players.forEach((player, index) => {
        const input = document.getElementById(`pointsInput-${index}`);
        let roundPoints = parseInt(input.value) || 0;

        // Si este jugador tiene el bonus -10, se le restan 10 puntos
        if (index === bonusIndex) {
          roundPoints -= 10;
        }

        player.points[currentRound] = roundPoints;
      });
      updateScoreTable();

      dealerIndex = (dealerIndex + 1) % players.length;

      if (currentRound === 6) {
        showFinalRanking();
      } else {
        currentRound++;
        showRoundInfo();
      }
    }

    /* Inicializar la tabla de puntuaciones */
    function initializeScoreTable() {
      const tbody = document.getElementById("scoreTableBody");
      tbody.innerHTML = "";
      players.forEach((player, index) => {
        const row = document.createElement("tr");
        row.id = `row-${index}`;

        // # Jugador
        const indexCell = document.createElement("td");
        indexCell.textContent = index + 1;
        row.appendChild(indexCell);

        // Nombre
        const nameCell = document.createElement("td");
        nameCell.textContent = player.name;
        row.appendChild(nameCell);

        // 7 celdas de cada ronda
        for (let i = 0; i < 7; i++) {
          const roundCell = document.createElement("td");
          roundCell.id = `score-${index}-r${i + 1}`;
          roundCell.textContent = "-";
          row.appendChild(roundCell);
        }

        // Total
        const totalCell = document.createElement("td");
        totalCell.id = `total-${index}`;
        totalCell.textContent = "0";
        row.appendChild(totalCell);

        tbody.appendChild(row);
      });
    }

    /* Actualizar tabla y destacar ganador/perdedor */
    function updateScoreTable() {
      players.forEach((player, index) => {
        let sum = 0;
        for (let i = 0; i < 7; i++) {
          const roundPoints = player.points[i] ?? 0;
          sum += roundPoints;
          const roundCell = document.getElementById(`score-${index}-r${i + 1}`);
          roundCell.textContent = roundPoints || roundPoints === 0 ? roundPoints : "-";
        }
        player.total = sum;
        document.getElementById(`total-${index}`).textContent = sum;
      });

      let minPoints = Infinity;
      let maxPoints = -Infinity;
      players.forEach((p) => {
        if (p.total < minPoints) minPoints = p.total;
        if (p.total > maxPoints) maxPoints = p.total;
      });

      // Limpiar y volver a aplicar estilos
      players.forEach((player, index) => {
        const row = document.getElementById(`row-${index}`);
        row.classList.remove("bg-winner", "bg-loser");

        // Jugador con menos puntos => verde suave
        if (player.total === minPoints) {
          row.classList.add("bg-winner");
        }
        // Jugador con más puntos => naranja suave
        if (player.total === maxPoints) {
          row.classList.add("bg-loser");
        }
      });
    }

    /* Mostrar Ranking Final */
    function showFinalRanking() {
      document.getElementById("roundInfoSection").classList.add("hidden");
      const finalRankingSection = document.getElementById("finalRankingSection");
      finalRankingSection.classList.remove("hidden");

      const sortedPlayers = [...players].sort((a, b) => a.total - b.total);
      const rankingList = document.getElementById("finalRankingList");
      rankingList.innerHTML = "";
      sortedPlayers.forEach((player) => {
        const li = document.createElement("li");
        li.textContent = `${player.name} - ${player.total} puntos`;
        li.classList.add("list-group-item");
        rankingList.appendChild(li);
      });
    }

    /* Reiniciar partida */
    function restartGame() {
      players.forEach((player) => {
        player.points = new Array(7).fill(null);
        player.total = 0;
      });
      currentRound = 0;
      dealerIndex = 0;

      document.getElementById("roundInfoSection").classList.remove("hidden");
      document.getElementById("finalRankingSection").classList.add("hidden");

      initializeScoreTable();
      showRoundInfo();
    }
  </script>
</body>
</html>
